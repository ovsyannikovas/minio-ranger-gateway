version: '3.8'

services:
  ranger-zk:
    image: apache/ranger-zk:2.7.0
    container_name: ranger-zk
    hostname: ranger-zk.example.com
    networks:
      - rangernw
    ports:
      - "2181:2181"
    healthcheck:
      test: [ "CMD", "sh", "-c", "nc -z localhost 2181 || exit 1" ]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 10s

  ranger-solr:
    image: apache/ranger-solr:2.7.0
    container_name: ranger-solr
    hostname: ranger-solr.example.com
    networks:
      - rangernw
    ports:
      - "8983:8983"
    depends_on:
      ranger-zk:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8983/solr || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s
    command: ["sh", "-c", "solr-precreate ranger_audits /opt/solr/server/solr/configsets/ranger_audits/ && tail -f /dev/null"]

  ranger-db:
    image: apache/ranger-db:2.7.0
    container_name: ranger-db
    hostname: ranger-db.example.com
    networks:
      - rangernw
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 30
      start_period: 20s

  ranger-admin:
    image: apache/ranger:2.7.0
    container_name: ranger
    hostname: ranger.example.com
    networks:
      - rangernw
    environment:
      - RANGER_VERSION=2.7.0
      - RANGER_DB_TYPE=postgres
      - RANGER_ADMIN_PASSWORD=rangerR0cks!
      - DB_root_user=postgres
      - DB_root_password=
      - DB_host=ranger-db
      - DB_port=5432
      - DB_name=rangerdb
      - DB_user=rangeruser
      - DB_password=rangerpass
      - DB_url=jdbc:postgresql://ranger-db:5432/rangerdb
    ports:
      - "6080:6080"
    depends_on:
      ranger-db:
        condition: service_healthy
      ranger-solr:
        condition: service_healthy
      ranger-zk:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:6080 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 20
      start_period: 180s
    command: >
      sh -c "
        echo 'Waiting for Ranger to start...' &&
        /home/ranger/scripts/ranger.sh &&
        sleep 30 &&
        tail -f /opt/ranger/admin/ews/logs/*.log
      "

  minio:
    image: minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: minio
    hostname: minio.example.com
    networks:
      - rangernw
    ports:
      - "9000:9000"
      - "9001:9001"
    depends_on:
      gateway:
        condition: service_healthy
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      - MINIO_SERVER_URL=http://minio:9000
      - MINIO_BROWSER_REDIRECT_URL=http://localhost:9001
      - MINIO_POLICY_PLUGIN_URL=http://gateway:8000/api/v1/check
    volumes:
      - minio_data:/data
    command: server /data --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  gateway:
    build:
      context: ./backend
    container_name: minio-ranger-gateway
    hostname: gateway.example.com
    networks:
      - rangernw
    ports:
      - "8000:8000"
    depends_on:
      ranger-admin:
        condition: service_healthy
    environment:
      # Ranger configuration
      - RANGER_HOST=http://ranger-admin:6080
      - RANGER_USER=admin
      - RANGER_PASSWORD=rangerR0cks!
      - RANGER_SERVICE_NAME=minio-service
      - RANGER_CACHE_TTL=300
      # MinIO configuration
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=password
      # FastAPI settings (minimal for gateway - no DB needed)
      - PROJECT_NAME=MinIO-Ranger Gateway
      - API_V1_STR=/api/v1
      - ENVIRONMENT=local
#      - IP_WHITELIST_RAW=172.19.0.7
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/utils/health-check/"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    command: >
      sh -c "
      python app/scripts/init_ranger.py &&
      fastapi run --host 0.0.0.0 --port 8000 app/main.py
      "

volumes:
  minio_data:

networks:
  rangernw: